#!/bin/bash

# Define log file
LOGFILE=~/transcript_audio_file.log

# Log function
log() {
  echo "$(date +'%Y-%m-%d %H:%M:%S') - $1" >> "$LOGFILE"
}

# Function to get absolute path of a file
get_absolute_path() {
  local file="$1"
  echo "$(cd "$(dirname "$file")"; pwd)/$(basename "$file")"
}

# Function to check if duration of MP3 file is less than 120 seconds
is_duration_less_than_120() {
    local file="$1"
    local duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$file")
    if [ $? -eq 0 ]; then
        # Check if duration is less than 120 seconds
        if (( $(echo "$duration < 120" | bc -l) )); then
            echo true
        else
            echo false
        fi
    else
        echo "Error: Failed to get duration of $file" >&2
        exit 1
    fi
}

# Start of script log
log "Script started"

# Check if duration is less than 120 seconds
mp3_file="$1"
log "is duration ok: $(is_duration_less_than_120 "$mp3_file")"
if ! $(is_duration_less_than_120 "$mp3_file"); then
    zenity --error --text="Error: The duration of the MP3 file is not less than 120 seconds." --title="Error"
    log "Error: The duration of the MP3 file is not less than 120 seconds."
    exit 1
fi

# Ask user for the action to perform
action=$(zenity --list --title="Action to perform" --text="Choose the action:" --radiolist --column="Select" --column="Action" --column="Help" TRUE "translation" "Translation into english only" FALSE "transcription" "Transcription with automatic language detection")

# Progress bar
(
  echo "# Starting the virtual env corresponding..."
  # activating virtual env corresponding to this script
  source ~/Documents/Projects/LLM/audio/env/bin/activate


  # Simulate processing step 2
  echo "# Starting the transcription/translation process, it might take a few minutes..."
  # Loop through all selected files
  for file in "$@"; do
    abs_file=$(get_absolute_path "$file")

    # Log the parameters and the file
    log "Transcripting/translating audio file $abs_file "

    # Launch the Python script with the file path and parameters
    python3 ~/Documents/Projects/nautilus/Custom_nautilus_scripts/python_scripts/AI/scripts.py -a "$action" -f "$abs_file" >> "$LOGFILE" 2>&1
  done

  echo "# Transcription/Translation done for $file"
) | zenity --progress --title="Transcripting/Translating Audio File" --text="Starting..." --percentage=0 --auto-close

log "Script ended"
